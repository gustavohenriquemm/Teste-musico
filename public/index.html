<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda de Hinos</title>
  <link rel="stylesheet" href="home.css">
  <link rel="apple-touch-icon" href="img/pql.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6a1b9a">
</head>
<body>
  <section class="central">

    <!-- Link para o formul√°rio -->
    <a class="Pagina001" href="Formulario.html">P√°gina 2</a>

    <!-- Calend√°rio -->
    <div class="calendar">
      <header>
        <button id="prev">&#9664;</button>
        <h2 id="monthYear"></h2>
        <button id="next">&#9654;</button>
      </header>
      <table>
        <thead>
          <tr>
            <th>Dom</th>
            <th>Seg</th>
            <th>Ter</th>
            <th>Qua</th>
            <th>Qui</th>
            <th>Sex</th>
            <th>S√°b</th>
          </tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>

    <!-- Tabelas de hinos -->
    <div id="tabelasHinos"></div>

    <!-- Bot√£o para limpar hinos -->
    <div class="container-botao">
      <button id="limparTabela">Limpar Tabela</button>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Editar Hino</h2>
        <form id="editForm">
          <label>Grupo:</label>
          <input type="text" name="grupo" required>
          
          <label>Data:</label>
          <input type="date" name="data" required>
          
          <label>Nome:</label>
          <input type="text" name="nome" required>
          
          <label>Link:</label>
          <input type="url" name="link">
          
          <label>Tom:</label>
          <input type="text" name="tom">
          
          <label>Atentem-se:</label>
          <input type="text" name="atentem">
          
          <button type="submit">Salvar Altera√ß√µes</button>
        </form>
      </div>
    </div>

  </section>

  <script>
  let hinoAtualIndex = null; // √≠ndice do hino que est√° sendo editado

  // ---------- CARREGAR HINOS EM TABELAS POR GRUPO ----------
  async function carregarHinosPorTabela() {
    try {
      const res = await fetch('/api/hino');
      const hinos = await res.json();
      const container = document.getElementById("tabelasHinos");
      container.innerHTML = "";

      // Agrupa hinos por grupo
      const grupos = {};
      hinos.forEach((hino, index) => {
        if (!grupos[hino.grupo]) grupos[hino.grupo] = [];
        grupos[hino.grupo].push({ ...hino, index });
      });

      // Cria tabela para cada grupo
      for (const grupo in grupos) {
        const titulo = document.createElement("h3");
        titulo.textContent = `Grupo: ${grupo}`;
        container.appendChild(titulo);

        const tabela = document.createElement("table");
        tabela.classList.add("mini-tabela");

        // Cabe√ßalho
        tabela.innerHTML = `
          <thead>
            <tr>
              <th>Data</th>
              <th>Nome do Hino</th>
              <th>Tom</th>
              <th>Atentem-se</th>
              <th>Link</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
        `;

        const tbody = document.createElement("tbody");
        grupos[grupo].forEach(hino => {
          const tr = document.createElement("tr");
          const dataFormatada = hino.data.includes("-") 
            ? `${hino.data.split("-")[2]}/${hino.data.split("-")[1]}/${hino.data.split("-")[0]}`
            : hino.data;

          tr.innerHTML = `
            <td>${dataFormatada}</td>
            <td>${hino.nome}</td>
            <td>${hino.tom || ''}</td>
            <td>${hino.atentem || 'Nenhum'}</td>
            <td><a href="${hino.link}" target="_blank">Assistir</a></td>
            <td>
              <button onclick="abrirModalEdicao(${hino.index})">‚úèÔ∏è</button>
              <button onclick="deletarHino(${hino.index})">üóë</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        tabela.appendChild(tbody);
        container.appendChild(tabela);
      }

    } catch (err) {
      console.error("Erro ao carregar hinos:", err);
    }
  }

  carregarHinosPorTabela();

  // ---------- LIMPAR TABELA ----------
  document.getElementById("limparTabela").addEventListener("click", async () => {
    if (!confirm("Deseja realmente limpar todos os hinos?")) return;
    try {
      await fetch('/api/hino', { method: 'DELETE' });
      carregarHinosPorTabela();
      alert("Hinos limpos com sucesso!");
    } catch (err) {
      console.error(err);
      alert("Erro ao limpar hinos!");
    }
  });

  // ---------- DELETAR HINO ----------
  async function deletarHino(index) {
    if (!confirm("Deseja realmente excluir este hino?")) return;
    try {
      const res = await fetch(`/api/hino/${index}`, { method: 'DELETE' });
      if (res.ok) {
        alert("‚úÖ Hino removido!");
        carregarHinosPorTabela();
      } else {
        alert("‚ùå Erro ao remover hino!");
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå Erro na conex√£o ao remover hino!");
    }
  }

  // ---------- MODAL DE EDI√á√ÉO ----------
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const closeBtn = document.querySelector(".close-btn");

  function abrirModalEdicao(index) {
    hinoAtualIndex = index;
    fetch('/api/hino')
      .then(res => res.json())
      .then(hinos => {
        const hino = hinos[index];
        if (!hino) return alert("Hino n√£o encontrado!");

        editForm.grupo.value = hino.grupo || '';
        editForm.data.value = hino.data || '';
        editForm.nome.value = hino.nome || '';
        editForm.link.value = hino.link || '';
        editForm.tom.value = hino.tom || '';
        editForm.atentem.value = hino.atentem || '';

        editModal.style.display = "block";
      });
  }

  closeBtn.onclick = () => editModal.style.display = "none";
  window.onclick = (event) => {
    if (event.target == editModal) editModal.style.display = "none";
  }

  editForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const dadosAtualizados = {
      grupo: editForm.grupo.value,
      data: editForm.data.value,
      nome: editForm.nome.value,
      link: editForm.link.value,
      tom: editForm.tom.value,
      atentem: editForm.atentem.value
    };

    fetch(`/api/hino/${hinoAtualIndex}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dadosAtualizados)
    })
    .then(res => {
      if(res.ok){
        alert("Hino atualizado com sucesso!");
        carregarHinosPorTabela();
        editModal.style.display = "none";
      } else {
        alert("Erro ao atualizar hino!");
      }
    })
    .catch(err => {
      console.error(err);
      alert("Erro na conex√£o ao atualizar hino!");
    });
  });

  // ---------- CALEND√ÅRIO ----------
  const monthYear = document.getElementById("monthYear");
  const calendarBody = document.getElementById("calendarBody");
  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");
  let currentDate = new Date();

  function renderCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    monthYear.textContent = `${months[month]} ${year}`;

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    calendarBody.innerHTML = "";
    let row = document.createElement("tr");

    for(let i = 0; i < firstDay; i++) row.appendChild(document.createElement("td"));

    for(let day = 1; day <= lastDate; day++){
      const cell = document.createElement("td");
      cell.textContent = day;

      const today = new Date();
      if(day === today.getDate() && month === today.getMonth() && year === today.getFullYear()){
        cell.classList.add("today");
      }

      row.appendChild(cell);

      if((firstDay + day) % 7 === 0){
        calendarBody.appendChild(row);
        row = document.createElement("tr");
      }
    }

    if(row.children.length > 0) calendarBody.appendChild(row);
  }
  prevBtn.addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar(currentDate);
  });
  nextBtn.addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar(currentDate);
  });
  renderCalendar(currentDate);

  </script>
</body>
</html>
