<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda de Hinos</title>
  <link rel="stylesheet" href="home.css">
  <link rel="apple-touch-icon" href="img/pql.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6a1b9a">
</head>
<body>
  <section class="central">

    <!-- Link para o formul√°rio -->
    <a class="Pagina001" href="Formulario.html">P√°gina 2</a>

    <!-- Calend√°rio -->
    <div class="calendar">
        <header>
          <button id="prev">&#9664;</button>
          <h2 id="monthYear"></h2>
          <button id="next">&#9654;</button>
        </header>
        <table>
          <thead>
            <tr>
              <th>Dom</th>
              <th>Seg</th>
              <th>Ter</th>
              <th>Qua</th>
              <th>Qui</th>
              <th>Sex</th>
              <th>S√°b</th>
            </tr>
          </thead>
          <tbody id="calendarBody"></tbody>
        </table>
      </div>

    <!-- Carrossel de hinos -->
    <div class="carousel-container">
      <div class="cards_container" id="cardsHinos"></div>
    </div>

    <!-- Bot√£o para limpar hinos -->
    <div class="container-botao">
      <button id="limparTabela">Limpar Tabela</button>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Editar Hino</h2>
        <form id="editForm">
          <label>Grupo:</label>
          <input type="text" name="grupo" required>
          
          <label>Data:</label>
          <input type="date" name="data" required>
          
          <label>Nome:</label>
          <input type="text" name="nome" required>
          
          <label>Link:</label>
          <input type="url" name="link">
          
          <label>Tom:</label>
          <input type="text" name="tom">
          
          <label>Atentem-se:</label>
          <input type="text" name="atentem">
          
          <button type="submit">Salvar Altera√ß√µes</button>
        </form>
      </div>
    </div>

  </section>

<script>
let hinoAtualIndex = null;

// ---------------- CARDS DE HINOS ----------------
async function carregarHinos() {
  try {
    const res = await fetch('/api/hino');
    const hinos = await res.json();
    const container = document.getElementById("cardsHinos");
    container.innerHTML = "";

    // Agrupa os hinos por data
    const hinosPorData = {};
    hinos.forEach((hino, index) => {
      const dataFormatada = hino.data.includes("-") ? hino.data.split("-").reverse().join("/") : hino.data;
      if (!hinosPorData[dataFormatada]) hinosPorData[dataFormatada] = [];
      hinosPorData[dataFormatada].push({ ...hino, index });
    });

    // Renderiza grupos de datas
    // Renderiza grupos de datas (ordenadas)
Object.keys(hinosPorData)
  .sort((a, b) => {
    // converte "dd/mm/yyyy" para Date p/ ordenar
    const [da, ma, ya] = a.split("/");
    const [db, mb, yb] = b.split("/");
    return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
  })
  .forEach(data => {

      // Bloco por data
      const blocoData = document.createElement("div");
      blocoData.classList.add("grupo-data");
      blocoData.setAttribute("data-data", data);

      // T√≠tulo da data
      const titulo = document.createElement("h2");
      titulo.classList.add("titulo-data");
      titulo.textContent = data;
      blocoData.appendChild(titulo);

      // Container de cards
      const cardsWrapper = document.createElement("div");
      cardsWrapper.classList.add("cards_wrapper");
      blocoData.appendChild(cardsWrapper);

      // Bot√µes de navega√ß√£o (individuais para cada data)
      const nav = document.createElement("div");
      nav.classList.add("cards_nav");

      const btnPrev = document.createElement("button");
      btnPrev.innerHTML = "&#9664;";
      const btnNext = document.createElement("button");
      btnNext.innerHTML = "&#9654;";

      btnPrev.addEventListener("click", () => {
        cardsWrapper.scrollBy({ left: -220, behavior: "smooth" });
      });
      btnNext.addEventListener("click", () => {
        cardsWrapper.scrollBy({ left: 220, behavior: "smooth" });
      });

      nav.appendChild(btnPrev);
      nav.appendChild(btnNext);
      blocoData.appendChild(nav);

      // Adiciona os cards
      hinosPorData[data].forEach(hino => {
        const card = document.createElement("div");
        card.classList.add("card");
        card.classList.add(`grupo_${hino.grupo.toLowerCase().replace(/\s/g, "_")}`);

        card.innerHTML = `
          <button class="edit-btn" onclick="abrirModalEdicao(${hino.index})">‚úèÔ∏è</button>
          <button class="delete-btn" onclick="deletarHino(${hino.index})">üóë</button>
          <h3 class="Card_grupo">Grupo: ${hino.grupo}</h3>
          <p class="Card_hino"><strong>Nome do Hino:</strong> ${hino.nome}</p>
          <p class="Card_tom"><strong>Tom:</strong> ${hino.tom || ''}</p>
          <p class="Card_atentem"><strong>Atentem-se:</strong> ${hino.atentem || 'Nenhum'}</p>
          <a href="${hino.link}" class="Card_link" target="_blank">Assistir</a>
        `;
        cardsWrapper.appendChild(card);
      });

      // Adiciona o grupo de data no container principal
      container.appendChild(blocoData);
    });

  } catch (err) {
    console.error("Erro ao carregar hinos:", err);
  }
}


// ---------------- DELETAR ----------------
async function deletarHino(index) {
  if (!confirm("Deseja realmente excluir este hino?")) return;
  try {
    const res = await fetch(`/api/hino/${index}`, { method: 'DELETE' });
    if (res.ok) {
      alert("‚úÖ Hino removido!");
      carregarHinos();
    } else {
      alert("‚ùå Erro ao remover hino!");
    }
  } catch (err) {
    console.error(err);
    alert("‚ùå Erro na conex√£o ao remover hino!");
  }
}

// ---------------- LIMPAR ----------------
document.getElementById("limparTabela").addEventListener("click", async () => {
  try {
    await fetch('/api/hino', { method: 'DELETE' });
    carregarHinos();
    alert("Cards de hinos limpos com sucesso!");
  } catch (err) {
    console.error(err);
    alert("Erro ao limpar cards!");
  }
});

// ---------------- MODAL DE EDI√á√ÉO ----------------
const editModal = document.getElementById("editModal");
const editForm = document.getElementById("editForm");
const closeBtn = document.querySelector(".close-btn");
let hinoAtualID = null; // agora usamos o ID real

// abrir modal e preencher dados
async function abrirModalEdicao(index) {
  try {
    const res = await fetch('/api/hino');
    const hinos = await res.json();
    const hino = hinos[index];
    if (!hino) return alert("Hino n√£o encontrado!");
    
    hinoAtualID = hino.id || index; // usa ID real se existir

    editForm.grupo.value = hino.grupo || '';
    editForm.data.value = hino.data || '';
    editForm.nome.value = hino.nome || '';
    editForm.link.value = hino.link || '';
    editForm.tom.value = hino.tom || '';
    editForm.atentem.value = hino.atentem || '';

    editModal.style.display = "block";
  } catch (err) {
    console.error(err);
    alert("Erro ao carregar hino para edi√ß√£o!");
  }
}

closeBtn.onclick = () => editModal.style.display = "none";
window.onclick = (event) => {
  if (event.target == editModal) editModal.style.display = "none";
};

// submit do formul√°rio
editForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!hinoAtualID) return alert("Hino n√£o selecionado!");

  const dadosAtualizados = {
    grupo: editForm.grupo.value,
    data: editForm.data.value,
    nome: editForm.nome.value,
    link: editForm.link.value,
    tom: editForm.tom.value,
    atentem: editForm.atentem.value
  };

  try {
    const res = await fetch(`/api/hino/${hinoAtualID}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dadosAtualizados)
    });

    if (res.ok) {
      alert("Hino atualizado com sucesso!");
      editModal.style.display = "none";
      carregarHinos();
    } else {
      const erro = await res.text();
      alert("Erro ao atualizar hino! " + erro);
    }
  } catch (err) {
    console.error(err);
    alert("Erro na conex√£o ao atualizar hino!");
  }
});


// ---------------- CALEND√ÅRIO ----------------
const monthYear = document.getElementById("monthYear");
const calendarBody = document.getElementById("calendarBody");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
let currentDate = new Date();

function renderCalendar(date) {
  const year = date.getFullYear();
  const month = date.getMonth();
  const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  monthYear.textContent = `${months[month]} ${year}`;

  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();

  calendarBody.innerHTML = "";
  let row = document.createElement("tr");

  for(let i = 0; i < firstDay; i++) row.appendChild(document.createElement("td"));

  for(let day = 1; day <= lastDate; day++){
    const cell = document.createElement("td");
    cell.textContent = day;

    const today = new Date();
    if(day === today.getDate() && month === today.getMonth() && year === today.getFullYear()){
      cell.classList.add("today");
    }

    row.appendChild(cell);

    if((firstDay + day) % 7 === 0){
      calendarBody.appendChild(row);
      row = document.createElement("tr");
    }
  }

  if(row.children.length > 0) calendarBody.appendChild(row);
}

prevBtn.addEventListener("click", () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar(currentDate);
});
nextBtn.addEventListener("click", () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar(currentDate);
});

renderCalendar(currentDate);
carregarHinos();
</script>
</body>
</html>
