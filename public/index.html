<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda de Hinos</title>
  <link rel="stylesheet" href="home.css">
  <link rel="apple-touch-icon" href="img/pql.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6a1b9a">

  <style>
    /* ======== POPUP DE BOAS-VINDAS ======== */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 25px 30px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 400px;
      animation: popupZoom 0.3s ease;
    }

    .popup-welcome h2 {
      margin-top: 0;
      color: #6a1b9a;
      font-size: 1.6em;
    }

    .popup-welcome p {
      color: #333;
      margin: 10px 0 20px;
    }

    .popup-welcome button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    #verHinosBtn {
      background: #6a1b9a;
      color: white;
    }

    #verHinosBtn:hover {
      background: #4a148c;
    }

    #fecharPopupBtn {
      background: #ccc;
      color: #333;
    }

    #fecharPopupBtn:hover {
      background: #bbb;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes popupZoom {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* ======== CALEND√ÅRIO ======== */
    .calendar {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .calendar header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #6a1b9a;
      margin-bottom: 10px;
    }

    .calendar table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
    }

    .calendar th {
      color: #6a1b9a;
      padding-bottom: 8px;
    }

    .calendar td {
      padding: 8px;
      cursor: default;
      border-radius: 6px;
    }

    .calendar td:hover {
      background: #f1e4fc;
    }

    .calendar td.today {
      background: #6a1b9a;
      color: white;
      font-weight: bold;
    }

    .calendar button {
      background: none;
      border: none;
      font-size: 20px;
      color: #6a1b9a;
      cursor: pointer;
    }

    /* ======== MODAL DE EDI√á√ÉO ======== */
    #editModal .modal-content {
      width: 90%;
      max-width: 450px;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    #editModal h2 {
      color: #6a1b9a;
      margin-top: 0;
    }

    #editForm label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      color: #333;
    }

    #editForm input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 5px;
    }

    #editForm button {
      margin-top: 15px;
      background: #6a1b9a;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      width: 100%;
      cursor: pointer;
      transition: 0.3s;
    }

    #editForm button:hover {
      background: #4a148c;
    }

    .close-btn {
      float: right;
      font-size: 24px;
      cursor: pointer;
      color: #777;
    }

    .close-btn:hover {
      color: #000;
    }

  </style>
</head>
<body>
  <section class="central">

    <!-- ======== CALEND√ÅRIO (AGORA NO TOPO) ======== -->
    <div class="calendar">
      <header>
        <button id="prev">&#9664;</button>
        <h2 id="monthYear"></h2>
        <button id="next">&#9654;</button>
      </header>
      <table>
        <thead>
          <tr>
            <th>Dom</th>
            <th>Seg</th>
            <th>Ter</th>
            <th>Qua</th>
            <th>Qui</th>
            <th>Sex</th>
            <th>S√°b</th>
          </tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>

    <!-- POPUP DE BOAS-VINDAS -->
    <div id="welcomeModal" class="modal">
      <div class="modal-content popup-welcome">
        <h2>Ol√°!</h2>
        <p>Deseja ver os hinos do congresso da cidade?</p>
        <button id="verHinosBtn">Sim, quero ver!</button>
        <button id="fecharPopupBtn">N√£o, obrigado</button>
      </div>
    </div>

    <!-- Link para o formul√°rio -->
    <a class="Pagina001" href="Formulario.html">P√°gina 2</a>

    <!-- Carrossel de hinos -->
    <div class="carousel-container">
      <div class="cards_container" id="cardsHinos"></div>
    </div>

    <!-- Bot√£o para limpar hinos -->
    <div class="container-botao">
      <button id="limparTabela">Limpar Tabela</button>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Editar Hino</h2>
        <form id="editForm">
          <label>Grupo:</label>
          <input type="text" name="grupo" required>
          
          <label>Data:</label>
          <input type="date" name="data" required>
          
          <label>Nome:</label>
          <input type="text" name="nome" required>
          
          <label>Link:</label>
          <input type="url" name="link">
          
          <label>Tom:</label>
          <input type="text" name="tom">
          
          <label>Atentem-se:</label>
          <input type="text" name="atentem">
          
          <button type="submit">Salvar Altera√ß√µes</button>
        </form>
      </div>
    </div>

  </section>

<script>
  // ======== POPUP DE BOAS-VINDAS ========
  const welcomeModal = document.getElementById("welcomeModal");
  const verHinosBtn = document.getElementById("verHinosBtn");
  const fecharPopupBtn = document.getElementById("fecharPopupBtn");

  if (!localStorage.getItem("popupShown")) {
    welcomeModal.classList.add("show");
  }

  verHinosBtn.addEventListener("click", () => {
    localStorage.setItem("popupShown", "true");
    window.location.href = "public/hinos_congresso.html";
  });

  fecharPopupBtn.addEventListener("click", () => {
    localStorage.setItem("popupShown", "true");
    welcomeModal.classList.remove("show");
  });

  // ======== CALEND√ÅRIO ========
  const monthYear = document.getElementById("monthYear");
  const calendarBody = document.getElementById("calendarBody");
  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");
  let currentDate = new Date();

  function renderCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    monthYear.textContent = `${months[month]} ${year}`;

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    calendarBody.innerHTML = "";
    let row = document.createElement("tr");

    for(let i = 0; i < firstDay; i++) row.appendChild(document.createElement("td"));

    for(let day = 1; day <= lastDate; day++){
      const cell = document.createElement("td");
      cell.textContent = day;

      const today = new Date();
      if(day === today.getDate() && month === today.getMonth() && year === today.getFullYear()){
        cell.classList.add("today");
      }

      row.appendChild(cell);

      if((firstDay + day) % 7 === 0){
        calendarBody.appendChild(row);
        row = document.createElement("tr");
      }
    }

    if(row.children.length > 0) calendarBody.appendChild(row);
  }

  prevBtn.addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar(currentDate);
  });
  nextBtn.addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar(currentDate);
  });

  renderCalendar(currentDate);

  // ======== FUN√á√ïES DE HINOS ========
  async function carregarHinos() {
    const res = await fetch('/api/hino');
    const hinos = await res.json();
    const container = document.getElementById("cardsHinos");
    container.innerHTML = "";

    const hinosPorData = {};
    hinos.forEach((hino, index) => {
      const dataFormatada = hino.data.includes("-") ? hino.data.split("-").reverse().join("/") : hino.data;
      if (!hinosPorData[dataFormatada]) hinosPorData[dataFormatada] = [];
      hinosPorData[dataFormatada].push({ ...hino, index });
    });

    Object.keys(hinosPorData)
      .sort((a, b) => {
        const [da, ma, ya] = a.split("/");
        const [db, mb, yb] = b.split("/");
        return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
      })
      .forEach(data => {
        const blocoData = document.createElement("div");
        blocoData.classList.add("grupo-data");
        blocoData.setAttribute("data-data", data);

        const titulo = document.createElement("h2");
        titulo.classList.add("titulo-data");
        titulo.textContent = data;
        blocoData.appendChild(titulo);

        const cardsWrapper = document.createElement("div");
        cardsWrapper.classList.add("cards_wrapper");
        blocoData.appendChild(cardsWrapper);

        const nav = document.createElement("div");
        nav.classList.add("cards_nav");

        const btnPrev = document.createElement("button");
        btnPrev.innerHTML = "&#9664;";
        const btnNext = document.createElement("button");
        btnNext.innerHTML = "&#9654;";

        btnPrev.addEventListener("click", () => {
          cardsWrapper.scrollBy({ left: -220, behavior: "smooth" });
        });
        btnNext.addEventListener("click", () => {
          cardsWrapper.scrollBy({ left: 220, behavior: "smooth" });
        });

        nav.appendChild(btnPrev);
        nav.appendChild(btnNext);
        blocoData.appendChild(nav);

        hinosPorData[data].forEach(hino => {
          const card = document.createElement("div");
          card.classList.add("card");
          card.classList.add(`grupo_${hino.grupo.toLowerCase().replace(/\s/g, "_")}`);

          card.innerHTML = `
            <button class="edit-btn" onclick="abrirModalEdicao(${hino.index})">‚úèÔ∏è</button>
            <button class="delete-btn" onclick="deletarHino(${hino.index})">üóë</button>
            <h3 class="Card_grupo">Grupo: ${hino.grupo}</h3>
            <p class="Card_hino"><strong>Nome do Hino:</strong> ${hino.nome}</p>
            <p class="Card_tom"><strong>Tom:</strong> ${hino.tom || ''}</p>
            <p class="Card_atentem"><strong>Atentem-se:</strong> ${hino.atentem || 'Nenhum'}</p>
            <a href="${hino.link}" class="Card_link" target="_blank">Assistir</a>
          `;
          cardsWrapper.appendChild(card);
        });

        container.appendChild(blocoData);
      });
  }

  async function deletarHino(index) {
    if (!confirm("Deseja realmente excluir este hino?")) return;
    await fetch(`/api/hino/${index}`, { method: 'DELETE' });
    alert("‚úÖ Hino removido!");
    carregarHinos();
  }

  document.getElementById("limparTabela").addEventListener("click", async () => {
    await fetch('/api/hino', { method: 'DELETE' });
    alert("Cards de hinos limpos com sucesso!");
    carregarHinos();
  });

  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const closeBtn = editModal.querySelector(".close-btn");
  let hinoAtualID = null;

  async function abrirModalEdicao(index) {
    const res = await fetch(`/api/hino/${index}`);
    const hino = await res.json();
    hinoAtualID = index;

    editForm.grupo.value = hino.grupo || '';
    editForm.data.value = hino.data || '';
    editForm.nome.value = hino.nome || '';
    editForm.link.value = hino.link || '';
    editForm.tom.value = hino.tom || '';
    editForm.atentem.value = hino.atentem || '';

    editModal.style.display = "flex";
  }

  closeBtn.onclick = () => (editModal.style.display = "none");
  window.onclick = (event) => {
    if (event.target == editModal) editModal.style.display = "none";
  };

  editForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (hinoAtualID === null) return alert("Hino n√£o selecionado!");

    const dadosAtualizados = {
      grupo: editForm.grupo.value,
      data: editForm.data.value,
      nome: editForm.nome.value,
      link: editForm.link.value,
      tom: editForm.tom.value,
      atentem: editForm.atentem.value
    };

    const res = await fetch(`/api/hino/${hinoAtualID}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dadosAtualizados)
    });

    if (res.ok) {
      alert("‚úÖ Hino atualizado com sucesso!");
      editModal.style.display = "none";
      carregarHinos();
    } else {
      alert("‚ùå Erro ao atualizar hino!");
    }
  });

  carregarHinos();
</script>
</body>
</html>
