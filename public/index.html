<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda de Hinos</title>
  <link rel="stylesheet" href="home.css">
  <link rel="apple-touch-icon" href="img/pql.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6a1b9a">
</head>
<body>
  <section class="central">

    <!-- ======== CALENDÁRIO ======== -->
    <div class="calendar">
      <header>
        <button id="prev">&#9664;</button>
        <h2 id="monthYear"></h2>
        <button id="next">&#9654;</button>
      </header>
      <table>
        <thead>
          <tr>
            <th>Dom</th>
            <th>Seg</th>
            <th>Ter</th>
            <th>Qua</th>
            <th>Qui</th>
            <th>Sex</th>
            <th>Sáb</th>
          </tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>

    <!-- POPUP DE BOAS-VINDAS -->
    <div id="welcomeModal" class="modal">
      <div class="modal-content popup-welcome">
        <h2>Olá!</h2>
        <p>Deseja ver os hinos do congresso da cidade?</p>
        <button id="verHinosBtn">Sim, quero ver!</button>
        <button id="fecharPopupBtn">Não, obrigado</button>
      </div>
    </div>

    <!-- Link para o formulário -->
    <a class="Pagina001" href="Formulario.html">Página 2</a>

    <!-- ======== TABELA DE HINOS ======== -->
    <div class="tabela-container">
      <table id="tabelaHinos">
        <thead>
          <tr>
            <th>Data</th>
            <th>Grupo</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal com Card do Hino -->
    <div id="hinoCardModal" class="modal">
      <div class="modal-content card-detalhe">
        <span class="close-btn">&times;</span>
        <div id="detalhesHino"></div>
      </div>
    </div>

    <!-- Botão para limpar tabela -->
    <div class="container-botao">
      <button id="limparTabela">Limpar Tabela</button>
    </div>

  </section>

<script>
  // ======== POPUP DE BOAS-VINDAS ========
  const welcomeModal = document.getElementById("welcomeModal");
  const verHinosBtn = document.getElementById("verHinosBtn");
  const fecharPopupBtn = document.getElementById("fecharPopupBtn");

  if (!localStorage.getItem("popupShown")) {
    welcomeModal.classList.add("show");
  }

  verHinosBtn.addEventListener("click", () => {
    localStorage.setItem("popupShown", "true");
    window.location.href = "public/hinos_congresso.html";
  });

  fecharPopupBtn.addEventListener("click", () => {
    localStorage.setItem("popupShown", "true");
    welcomeModal.classList.remove("show");
  });

  // ======== CALENDÁRIO ========
  const monthYear = document.getElementById("monthYear");
  const calendarBody = document.getElementById("calendarBody");
  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");
  let currentDate = new Date();

  function renderCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const months = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    monthYear.textContent = `${months[month]} ${year}`;

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    calendarBody.innerHTML = "";
    let row = document.createElement("tr");

    for(let i = 0; i < firstDay; i++) row.appendChild(document.createElement("td"));

    for(let day = 1; day <= lastDate; day++){
      const cell = document.createElement("td");
      cell.textContent = day;
      const today = new Date();
      if(day === today.getDate() && month === today.getMonth() && year === today.getFullYear()){
        cell.classList.add("today");
      }
      row.appendChild(cell);
      if((firstDay + day) % 7 === 0){
        calendarBody.appendChild(row);
        row = document.createElement("tr");
      }
    }
    if(row.children.length > 0) calendarBody.appendChild(row);
  }

  prevBtn.addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar(currentDate);
  });
  nextBtn.addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar(currentDate);
  });
  renderCalendar(currentDate);

  // ======== TABELA DE HINOS ========
  async function carregarHinos() {
    const res = await fetch('/api/hino');
    const hinos = await res.json();
    const tbody = document.querySelector("#tabelaHinos tbody");
    tbody.innerHTML = "";

    hinos.forEach((hino, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${hino.data}</td>
        <td>${hino.grupo}</td>
        <td class="acoes">
          <button class="menu-btn" onclick="abrirCard(${index})">⋮</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ======== MODAL COM CARD DETALHADO ========
  const hinoCardModal = document.getElementById("hinoCardModal");
  const detalhesHino = document.getElementById("detalhesHino");
  const closeBtn = hinoCardModal.querySelector(".close-btn");

  async function abrirCard(index) {
    const res = await fetch(`/api/hino/${index}`);
    const hino = await res.json();

    detalhesHino.innerHTML = `
      <h3>Grupo: ${hino.grupo}</h3>
      <p><strong>Nome do Hino:</strong> ${hino.nome}</p>
      <p><strong>Data:</strong> ${hino.data}</p>
      <p><strong>Tom:</strong> ${hino.tom || '—'}</p>
      <p><strong>Atentem-se:</strong> ${hino.atentem || 'Nenhum'}</p>
      <a href="${hino.link}" target="_blank" class="linkCard">Assistir</a>
    `;
    hinoCardModal.style.display = "flex";
  }

  closeBtn.onclick = () => (hinoCardModal.style.display = "none");
  window.onclick = (event) => {
    if (event.target == hinoCardModal) hinoCardModal.style.display = "none";
  };

  document.getElementById("limparTabela").addEventListener("click", async () => {
    await fetch('/api/hino', { method: 'DELETE' });
    alert("Tabela limpa com sucesso!");
    carregarHinos();
  });

  carregarHinos();
</script>
</body>
</html>
